<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsyFi Admin Panel</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .admin-card {
            background: var(--pf-bg-1);
            border: 1px solid var(--pf-border-subtle);
            border-radius: 8px;
            padding: 1.5rem;
        }
        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--pf-border-subtle);
        }
        .admin-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--pf-cyan);
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .status-healthy {
            background: rgba(0, 255, 100, 0.1);
            color: #00ff64;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--pf-border-subtle);
        }
        .stat-label {
            color: var(--pf-text-subtle);
        }
        .stat-value {
            color: var(--pf-text);
            font-family: 'JetBrains Mono', monospace;
        }
        .engine-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .engine-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--pf-bg-0);
            border-radius: 6px;
        }
        .engine-name {
            font-family: 'JetBrains Mono', monospace;
            color: var(--pf-cyan);
        }
        .engine-category {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            background: var(--pf-bg-2);
            color: var(--pf-text-subtle);
        }
        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--pf-bg-0);
            border-radius: 6px;
        }
        .run-table {
            width: 100%;
            border-collapse: collapse;
        }
        .run-table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 2px solid var(--pf-border-strong);
            color: var(--pf-text-subtle);
            font-weight: 500;
        }
        .run-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--pf-border-subtle);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        .btn-action {
            padding: 0.5rem 1rem;
            background: var(--pf-cyan);
            color: var(--pf-bg-0);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-action:hover {
            background: var(--pf-magenta);
        }
        .btn-danger {
            background: #ff4444;
        }
        .btn-danger:hover {
            background: #cc0000;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div>
                <h1 style="margin: 0; color: var(--pf-cyan);">‚¨° PsyFi Admin Panel</h1>
                <p style="margin: 0.5rem 0 0 0; color: var(--pf-text-subtle);">System Management & Configuration</p>
            </div>
            <div>
                <a href="/" class="btn-action">‚Üê Back to Simulator</a>
            </div>
        </div>

        <!-- System Status -->
        <div class="admin-card" style="margin-bottom: 2rem;">
            <div class="admin-card-header">
                <div class="admin-card-title">üñ•Ô∏è System Status</div>
                <span class="status-badge status-healthy" id="systemStatus">‚óè  Healthy</span>
            </div>
            <div>
                <div class="stat-row">
                    <span class="stat-label">Version</span>
                    <span class="stat-value" id="version">Loading...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ABX-Core</span>
                    <span class="stat-value" id="abxCore">v1.3</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Engines Available</span>
                    <span class="stat-value" id="enginesCount">Loading...</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Presets Loaded</span>
                    <span class="stat-value" id="presetsCount">Loading...</span>
                </div>
                <div class="stat-row" style="border-bottom: none;">
                    <span class="stat-label">Last Updated</span>
                    <span class="stat-value" id="timestamp">Loading...</span>
                </div>
            </div>
        </div>

        <div class="admin-grid">
            <!-- Engine Registry -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <div class="admin-card-title">üîß Engine Registry</div>
                    <span class="stat-value" id="engineCount">0</span>
                </div>
                <div class="engine-list" id="engineList">
                    <p style="color: var(--pf-text-subtle); text-align: center;">Loading engines...</p>
                </div>
            </div>

            <!-- Presets & Profiles -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <div class="admin-card-title">üß™ Substance Presets</div>
                    <span class="stat-value" id="presetCount">0</span>
                </div>
                <div class="engine-list" id="presetList">
                    <p style="color: var(--pf-text-subtle); text-align: center;">Loading presets...</p>
                </div>
            </div>

            <!-- Configuration -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <div class="admin-card-title">‚öôÔ∏è Configuration</div>
                </div>
                <div>
                    <div class="stat-row">
                        <span class="stat-label">Environment</span>
                        <span class="stat-value" id="environment">production</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Safety Clamp</span>
                        <span class="stat-value" id="safetyClamp">Enabled</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Max Field Size</span>
                        <span class="stat-value" id="maxFieldSize">512</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Max Steps</span>
                        <span class="stat-value" id="maxSteps">1000</span>
                    </div>
                    <div class="stat-row" style="border-bottom: none;">
                        <span class="stat-label">Default Seed</span>
                        <span class="stat-value" id="defaultSeed">42</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Run History -->
        <div class="admin-card">
            <div class="admin-card-header">
                <div class="admin-card-title">üìä Run History</div>
                <button class="btn-action btn-danger" onclick="clearHistory()">Clear History</button>
            </div>
            <div style="overflow-x: auto;">
                <table class="run-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Scenario</th>
                            <th>Dimensions</th>
                            <th>Steps</th>
                            <th>Valence</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--pf-text-subtle);">
                                No runs yet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--pf-border-subtle);">
            <p style="color: var(--pf-text-subtle);">
                Applied Alchemy Labs ‚Ä¢ ABX-Core v1.3 ‚Ä¢ <a href="/docs" target="_blank" style="color: var(--pf-cyan);">API Docs</a>
            </p>
        </div>
    </div>

    <script>
        // Load system status
        async function loadSystemStatus() {
            try {
                const res = await fetch('/admin/api/status');
                const data = await res.json();

                document.getElementById('version').textContent = data.version;
                document.getElementById('abxCore').textContent = data.abx_core;
                document.getElementById('enginesCount').textContent = data.engines_available;
                document.getElementById('presetsCount').textContent = data.presets_loaded;
                document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString();
            } catch (err) {
                console.error('Failed to load system status:', err);
            }
        }

        // Load engines
        async function loadEngines() {
            try {
                const res = await fetch('/admin/api/engines');
                const data = await res.json();

                const engineList = document.getElementById('engineList');
                const engines = data.engines;

                document.getElementById('engineCount').textContent = engines.length;

                if (engines.length === 0) {
                    engineList.innerHTML = '<p style="color: var(--pf-text-subtle);">No engines found</p>';
                    return;
                }

                engineList.innerHTML = engines.map(engine => `
                    <div class="engine-item">
                        <span class="engine-name">${engine.name}</span>
                        <span class="engine-category">${engine.category}</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load engines:', err);
            }
        }

        // Load presets
        async function loadPresets() {
            try {
                const res = await fetch('/admin/api/presets');
                const data = await res.json();

                const presetList = document.getElementById('presetList');
                const presets = data.presets;

                document.getElementById('presetCount').textContent = presets.length;

                if (presets.length === 0) {
                    presetList.innerHTML = '<p style="color: var(--pf-text-subtle);">No presets found</p>';
                    return;
                }

                presetList.innerHTML = presets.map(preset => `
                    <div class="preset-item">
                        <span class="engine-name">${preset.name}</span>
                        <span class="engine-category">${preset.class}</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load presets:', err);
            }
        }

        // Load configuration
        async function loadConfig() {
            try {
                const res = await fetch('/admin/api/config');
                const data = await res.json();

                document.getElementById('environment').textContent = data.environment;
                document.getElementById('safetyClamp').textContent = data.safety_clamp ? 'Enabled' : 'Disabled';
                document.getElementById('maxFieldSize').textContent = data.max_field_size;
                document.getElementById('maxSteps').textContent = data.max_steps;
                document.getElementById('defaultSeed').textContent = data.default_seed;
            } catch (err) {
                console.error('Failed to load config:', err);
            }
        }

        // Load run history
        async function loadHistory() {
            try {
                const res = await fetch('/admin/api/history');
                const data = await res.json();

                const historyBody = document.getElementById('historyBody');
                const runs = data.runs;

                if (runs.length === 0) {
                    historyBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--pf-text-subtle);">No runs yet</td></tr>';
                    return;
                }

                historyBody.innerHTML = runs.reverse().slice(0, 20).map(run => `
                    <tr>
                        <td>${new Date(run.timestamp).toLocaleString()}</td>
                        <td>${run.scenario}</td>
                        <td>${run.width}√ó${run.height}</td>
                        <td>${run.steps}</td>
                        <td>${run.metrics.valence?.toFixed(3) || 'N/A'}</td>
                        <td>${run.duration_ms?.toFixed(0) || 'N/A'}ms</td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        // Clear history
        async function clearHistory() {
            if (!confirm('Clear all run history?')) return;

            try {
                await fetch('/admin/api/history', { method: 'DELETE' });
                loadHistory();
            } catch (err) {
                console.error('Failed to clear history:', err);
                alert('Failed to clear history');
            }
        }

        // Initialize
        loadSystemStatus();
        loadEngines();
        loadPresets();
        loadConfig();
        loadHistory();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadSystemStatus();
            loadHistory();
        }, 30000);
    </script>
</body>
</html>
